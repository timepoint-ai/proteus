{% extends "base.html" %}

{% block title %}Transactions - Proteus Node Operator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <i class="fas fa-exchange-alt me-2"></i>
            Transaction Monitor
        </h1>
    </div>
</div>

<!-- Transaction Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Total Transactions</h5>
                        <h2 class="mb-0">{{ stats.total_transactions or 0 }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-list fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Confirmed</h5>
                        <h2 class="mb-0">{{ stats.confirmed_transactions or 0 }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Pending</h5>
                        <h2 class="mb-0">{{ stats.pending_transactions or 0 }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Failed</h5>
                        <h2 class="mb-0">{{ stats.failed_transactions or 0 }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-times-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Volume and Fees -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-coins me-2"></i>
                    Transaction Volume
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <i class="fab fa-ethereum fa-2x text-primary mb-2"></i>
                            <h4 class="mb-0">{{ stats.eth_volume or 0 }}</h4>
                            <small class="text-muted">ETH Total Volume</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <i class="fab fa-bitcoin fa-2x text-warning mb-2"></i>
                            <h4 class="mb-0">{{ stats.btc_volume or 0 }}</h4>
                            <small class="text-muted">BTC Total Volume</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-percentage me-2"></i>
                    Platform Fees Collected
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <i class="fab fa-ethereum fa-2x text-primary mb-2"></i>
                            <h4 class="mb-0">{{ stats.eth_fees or 0 }}</h4>
                            <small class="text-muted">ETH Fees (1%)</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <i class="fab fa-bitcoin fa-2x text-warning mb-2"></i>
                            <h4 class="mb-0">{{ stats.btc_fees or 0 }}</h4>
                            <small class="text-muted">BTC Fees (1%)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>
                    Transaction Filters
                </h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="currency" class="form-label">Currency</label>
                        <select name="currency" id="currency" class="form-select">
                            <option value="">All Currencies</option>
                            <option value="ETH" {{ 'selected' if request.args.get('currency') == 'ETH' }}>ETH</option>
                            <option value="BTC" {{ 'selected' if request.args.get('currency') == 'BTC' }}>BTC</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="type" class="form-label">Type</label>
                        <select name="type" id="type" class="form-select">
                            <option value="">All Types</option>
                            <option value="stake" {{ 'selected' if request.args.get('type') == 'stake' }}>Stake</option>
                            <option value="payout" {{ 'selected' if request.args.get('type') == 'payout' }}>Payout</option>
                            <option value="fee" {{ 'selected' if request.args.get('type') == 'fee' }}>Fee</option>
                            <option value="bet_creation" {{ 'selected' if request.args.get('type') == 'bet_creation' }}>Bet Creation</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">Status</label>
                        <select name="status" id="status" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="pending" {{ 'selected' if request.args.get('status') == 'pending' }}>Pending</option>
                            <option value="confirmed" {{ 'selected' if request.args.get('status') == 'confirmed' }}>Confirmed</option>
                            <option value="failed" {{ 'selected' if request.args.get('status') == 'failed' }}>Failed</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="per_page" class="form-label">Per Page</label>
                        <select name="per_page" id="per_page" class="form-select">
                            <option value="20" {{ 'selected' if request.args.get('per_page') == '20' }}>20</option>
                            <option value="50" {{ 'selected' if request.args.get('per_page') == '50' }}>50</option>
                            <option value="100" {{ 'selected' if request.args.get('per_page') == '100' }}>100</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>
                            Filter Transactions
                        </button>
                        <a href="{{ url_for('admin.transactions_view') }}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>
                            Clear Filters
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Transaction List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>
                    Transaction History
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshTransactions()">
                    <i class="fas fa-sync me-1"></i>
                    Refresh
                </button>
            </div>
            <div class="card-body">
                {% if transactions and transactions.items %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Transaction Hash</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Currency</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Platform Fee</th>
                                    <th>Status</th>
                                    <th>Block</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tx in transactions.items %}
                                <tr>
                                    <td>
                                        <code class="small">{{ tx.transaction_hash[:16] }}...</code>
                                        <button class="btn btn-sm btn-link p-0 ms-1" 
                                                onclick="copyToClipboard('{{ tx.transaction_hash }}')"
                                                title="Copy full hash">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            {{ tx.transaction_type.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong>{{ tx.amount }}</strong>
                                    </td>
                                    <td>
                                        <i class="fab fa-{{ 'ethereum' if tx.currency == 'ETH' else 'bitcoin' }} me-1"></i>
                                        {{ tx.currency }}
                                    </td>
                                    <td>
                                        <code class="small">{{ tx.from_address[:10] }}...</code>
                                    </td>
                                    <td>
                                        <code class="small">{{ tx.to_address[:10] }}...</code>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ tx.platform_fee }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if tx.status == 'confirmed' else 'warning' if tx.status == 'pending' else 'danger' }}">
                                            {{ tx.status.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if tx.block_number %}
                                            <small class="text-muted">{{ tx.block_number }}</small>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ tx.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" 
                                                    onclick="viewTransaction('{{ tx.id }}')"
                                                    title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if tx.related_bet_id %}
                                                <button class="btn btn-outline-info" 
                                                        onclick="viewBet('{{ tx.related_bet_id }}')"
                                                        title="View Related Bet">
                                                    <i class="fas fa-dice"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if transactions.pages > 1 %}
                        <nav aria-label="Transaction pagination">
                            <ul class="pagination justify-content-center">
                                {% if transactions.has_prev %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('admin.transactions_view', page=transactions.prev_num, **request.args) }}">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                
                                {% for page_num in transactions.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != transactions.page %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ url_for('admin.transactions_view', page=page_num, **request.args) }}">
                                                    {{ page_num }}
                                                </a>
                                            </li>
                                        {% else %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ page_num }}</span>
                                            </li>
                                        {% endif %}
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if transactions.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('admin.transactions_view', page=transactions.next_num, **request.args) }}">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                        
                        <div class="text-center text-muted">
                            Showing {{ transactions.per_page * (transactions.page - 1) + 1 }} to 
                            {{ transactions.per_page * (transactions.page - 1) + transactions.items|length }} of 
                            {{ transactions.total }} transactions
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No transactions found</h5>
                        <p class="text-muted">
                            {% if request.args %}
                                Try adjusting your filters or 
                                <a href="{{ url_for('admin.transactions_view') }}">clear all filters</a>
                            {% else %}
                                Transactions will appear here once users start placing bets and stakes.
                            {% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel">
                    <i class="fas fa-exchange-alt me-2"></i>
                    Transaction Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="transactionModalBody">
                <!-- Transaction details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-download me-2"></i>
                    Export Options
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100" onclick="exportTransactions('csv')">
                            <i class="fas fa-file-csv me-2"></i>
                            Export as CSV
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-success w-100" onclick="exportTransactions('xlsx')">
                            <i class="fas fa-file-excel me-2"></i>
                            Export as Excel
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-info w-100" onclick="exportTransactions('json')">
                            <i class="fas fa-file-code me-2"></i>
                            Export as JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Copy transaction hash to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-white bg-success border-0';
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    Transaction hash copied to clipboard!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', function() {
            document.body.removeChild(toast);
        });
    });
}

// View transaction details
function viewTransaction(transactionId) {
    fetch(`/admin/api/transaction/${transactionId}`)
        .then(response => response.json())
        .then(data => {
            const modalBody = document.getElementById('transactionModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Transaction Information</h6>
                        <p><strong>ID:</strong> ${data.id}</p>
                        <p><strong>Hash:</strong> <code>${data.transaction_hash}</code></p>
                        <p><strong>Type:</strong> ${data.transaction_type}</p>
                        <p><strong>Status:</strong> 
                            <span class="badge bg-${data.status === 'confirmed' ? 'success' : data.status === 'pending' ? 'warning' : 'danger'}">
                                ${data.status}
                            </span>
                        </p>
                        <p><strong>Created:</strong> ${data.created_at}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Amount Details</h6>
                        <p><strong>Amount:</strong> ${data.amount} ${data.currency}</p>
                        <p><strong>Platform Fee:</strong> ${data.platform_fee} ${data.currency}</p>
                        <p><strong>From:</strong> <code>${data.from_address}</code></p>
                        <p><strong>To:</strong> <code>${data.to_address}</code></p>
                        <p><strong>Block:</strong> ${data.block_number || 'Not confirmed'}</p>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching transaction details:', error);
            alert('Failed to load transaction details');
        });
}

// View related bet
function viewBet(betId) {
    window.location.href = `/admin/bets?bet_id=${betId}`;
}

// Refresh transactions
function refreshTransactions() {
    location.reload();
}

// Export transactions
function exportTransactions(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('format', format);
    window.location.href = `/admin/api/export/transactions?${params.toString()}`;
}

// Auto-refresh transaction list every 60 seconds
setInterval(function() {
    // Only refresh if we're on the first page to avoid disrupting navigation
    if ({{ transactions.page if transactions else 1 }} === 1) {
        fetch('/admin/api/transactions-summary')
            .then(response => response.json())
            .then(data => {
                // Update statistics without full page reload
                updateTransactionStats(data);
            })
            .catch(error => console.error('Error updating transaction stats:', error));
    }
}, 60000);

// Update transaction statistics
function updateTransactionStats(data) {
    // Update the statistics cards with new data
    const statsCards = document.querySelectorAll('.card h2');
    if (statsCards.length >= 4) {
        statsCards[0].textContent = data.total_transactions || 0;
        statsCards[1].textContent = data.confirmed_transactions || 0;
        statsCards[2].textContent = data.pending_transactions || 0;
        statsCards[3].textContent = data.failed_transactions || 0;
    }
}
</script>
{% endblock %}
