{% extends "base.html" %}

{% block title %}Market Detail - Clockchain Node Operator{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">Market Detail</h1>
                <div class="d-flex gap-2">
                    <a href="/clockchain" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Timeline
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-dice"></i> {{ actor.name if actor else 'Unknown Actor' }} Market
                        <span class="badge bg-{{ 'success' if market.status == 'resolved' else 'primary' if market.status == 'active' else 'secondary' }} ms-2">
                            {{ market.status.title() }}
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Time Window</h6>
                            <p class="text-muted">
                                <strong>Start:</strong> {{ market.start_time.strftime('%Y-%m-%d %H:%M:%S UTC') if market.start_time else 'Not set' }}<br>
                                <strong>End:</strong> {{ market.end_time.strftime('%Y-%m-%d %H:%M:%S UTC') if market.end_time else 'Not set' }}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6>Market Statistics</h6>
                            <p class="text-muted">
                                <strong>Total Volume:</strong> {{ total_volume }} ETH<br>
                                <strong>Submissions:</strong> {{ submissions|length }}<br>
                                <strong>Total Bets:</strong> {{ all_bets|length }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submissions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list"></i> Competing Submissions ({{ submissions|length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if submissions %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Predicted Text</th>
                                        <th>Creator</th>
                                        <th>Initial Stake</th>
                                        <th>Bets</th>
                                        <th>Total Volume</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for submission in submissions %}
                                    {% set submission_bets = all_bets | selectattr('submission.id', 'equalto', submission.id) | list %}
                                    {% set submission_volume = submission_bets | sum(attribute='bet.amount') %}
                                    <tr class="{{ 'table-success' if submission.is_winner else '' }}">
                                        <td>
                                            <span class="badge bg-{{ 'primary' if submission.submission_type == 'original' else 'secondary' }}">
                                                {{ submission.submission_type.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <div style="max-width: 300px; word-wrap: break-word;">
                                                "{{ submission.predicted_text or '[No prediction]' }}"
                                            </div>
                                        </td>
                                        <td>
                                            <small class="text-muted font-monospace">
                                                {{ submission.creator_wallet[:10] + '...' if submission.creator_wallet else 'Unknown' }}
                                            </small>
                                        </td>
                                        <td>
                                            <strong>{{ submission.initial_stake_amount }} {{ submission.currency }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ submission_bets|length }}</span>
                                        </td>
                                        <td>
                                            <strong>{{ submission_volume }} {{ submission.currency }}</strong>
                                        </td>
                                        <td>
                                            {% if submission.is_winner %}
                                                <span class="badge bg-success">Winner</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Pending</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-list fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Submissions</h5>
                            <p class="text-muted">This market has no competing submissions yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- All Bets -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-coins"></i> All Bets ({{ all_bets|length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if all_bets %}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Bettor</th>
                                        <th>Submission</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Transaction</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bet_data in all_bets %}
                                    <tr>
                                        <td>
                                            <small class="text-muted font-monospace">
                                                {{ bet_data.bet.bettor_wallet[:10] + '...' if bet_data.bet.bettor_wallet else 'Unknown' }}
                                            </small>
                                        </td>
                                        <td>
                                            <small>
                                                "{{ bet_data.submission_text }}"
                                                <span class="badge bg-{{ 'primary' if bet_data.submission.submission_type == 'original' else 'secondary' }} ms-1">
                                                    {{ bet_data.submission.submission_type }}
                                                </span>
                                            </small>
                                        </td>
                                        <td>
                                            <strong>{{ bet_data.bet.amount }} {{ bet_data.bet.currency }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if bet_data.bet.status == 'confirmed' else 'warning' if bet_data.bet.status == 'pending' else 'danger' }}">
                                                {{ bet_data.bet.status.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if bet_data.bet.transaction_hash %}
                                                <small class="text-muted font-monospace">
                                                    {{ bet_data.bet.transaction_hash[:10] + '...' }}
                                                </small>
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ bet_data.bet.created_at.strftime('%m/%d %H:%M') if bet_data.bet.created_at else 'Unknown' }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-coins fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Bets</h5>
                            <p class="text-muted">No bets have been placed on this market yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}