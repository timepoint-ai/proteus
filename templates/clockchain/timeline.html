{% extends "base.html" %}

{% block title %}Clockchain Timeline - Clockchain Node Operator{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">Clockchain Timeline</h1>
                <div class="d-flex gap-2">
                    <div class="text-muted">
                        <i class="fas fa-chart-line"></i> Active: {{ active_bet_count }} | Volume: {{ total_bet_volume }} ETH
                    </div>
                    <a href="{{ url_for('clockchain.create_market') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create Market
                    </a>
                    <a href="/" class="btn btn-secondary">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="btn-group" role="group">
                <a href="/clockchain" class="btn btn-{{ 'primary' if view_type == 'all' else 'outline-primary' }}">
                    <i class="fas fa-clock"></i> All Predictions
                </a>
                <a href="/clockchain/active" class="btn btn-{{ 'primary' if view_type == 'active' else 'outline-primary' }}">
                    <i class="fas fa-hourglass-half"></i> Active Predictions
                </a>
                <a href="/clockchain/resolved" class="btn btn-{{ 'primary' if view_type == 'resolved' else 'outline-primary' }}">
                    <i class="fas fa-check-circle"></i> Resolved Submissions
                </a>
            </div>
        </div>
    </div>

    <!-- Current Time Display -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Current Pacific Time:</strong> <span class="text-primary" id="currentTime">{{ time_status.current_time or 'Loading...' }}</span>
                        </div>
                        <div class="text-muted">
                            {% if view_type == 'all' %}
                                Showing upcoming predictions first, then recent resolved ones
                            {% elif view_type == 'active' %}
                                Showing only active predictions
                            {% elif view_type == 'resolved' %}
                                Showing resolved predictions by resolution time
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline View -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        Linguistic Prediction Timeline
                        {% if has_more_records %}
                        <span class="badge bg-warning float-end">
                            Showing {{ displayed_count }} of {{ total_count }} submissions
                        </span>
                        {% elif total_count > 0 %}
                        <span class="badge bg-secondary float-end">
                            {{ total_count }} submissions
                        </span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body" style="overflow-y: auto; max-height: none;">
                    <!-- Timeline Segments -->
                    <div class="timeline-container" style="position: relative; padding: 20px 0;">
                        {% set now_marker_shown = false %}
                        {% for segment in timeline_segments %}
                        
                        {% if not now_marker_shown and segment.start_ms > current_time_ms %}
                            {% set now_marker_shown = true %}
                            <!-- Current Time Marker -->
                            <div class="w-100 my-4">
                                <div class="d-flex align-items-center">
                                    <div class="bg-danger" style="height: 2px; flex: 1;"></div>
                                    <span class="badge bg-danger mx-2">NOW</span>
                                    <div class="bg-danger" style="height: 2px; flex: 1;"></div>
                                </div>
                            </div>
                        {% endif %}
                        
                        <div class="timeline-segment mb-4" 
                             data-start="{{ segment.start_ms }}" 
                             data-end="{{ segment.end_ms }}"
                             data-bet-id="{{ segment.id }}">
                            <div class="row">
                                <div class="col-2 text-end">
                                    <small class="text-muted">
                                        {{ segment.start_time.strftime('%m/%d %H:%M') }}<br>
                                        to<br>
                                        {{ segment.end_time.strftime('%m/%d %H:%M') }}
                                    </small>
                                </div>
                                <div class="col-1 text-center">
                                    <div class="timeline-marker bg-{{ 'success' if segment.status == 'resolved' else 'primary' if segment.status == 'active' else 'secondary' }}" 
                                         style="width: 16px; height: 16px; border-radius: 50%; margin: 0 auto; position: relative; z-index: 2;">
                                    </div>
                                </div>
                                <div class="col-9">
                                    <div class="card mb-3 {{ 'border-success' if segment.status == 'resolved' else 'border-primary' if segment.status == 'active' else '' }}">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div>
                                                    <h5 class="card-title mb-1">
                                                        <span class="text-primary">
                                                            @{{ segment.actor.x_username }}
                                                            {% if segment.actor.verified %}
                                                                <i class="fas fa-check-circle text-info" title="Verified"></i>
                                                            {% endif %}
                                                        </span>
                                                        <small class="text-muted">{{ segment.actor.display_name }}</small>
                                                        <span class="badge bg-{{ 'success' if segment.status == 'resolved' else 'primary' if segment.status == 'active' else 'secondary' }} ms-2">
                                                            {{ segment.status }}
                                                        </span>
                                                    </h5>
                                                    <h6 class="card-subtitle text-muted">
                                                        Submission by {{ segment.creator_wallet }}
                                                    </h6>
                                                </div>
                                                <div class="text-end">
                                                    <h4 class="mb-0">{{ segment.total_volume }} {{ segment.currency }}</h4>
                                                    <small class="text-muted">Total Volume</small>
                                                </div>
                                            </div>
                                            
                                            <div class="prediction-text mb-3">
                                                <strong>Predicted Text:</strong>
                                                <div class="bg-dark text-white p-3 rounded mt-1 border">
                                                    <em>"{{ segment.predicted_text }}"</em>
                                                </div>
                                            </div>
                                            
                                            {% if segment.resolution %}
                                            <div class="resolution-info mb-3">
                                                <strong>Resolution:</strong>
                                                <div class="bg-success text-white p-3 rounded mt-1 border">
                                                    <div>Actual: <em>"{{ segment.resolution.actual_text }}"</em></div>
                                                    <div class="mt-2">
                                                        <span class="badge bg-info">Levenshtein Distance: {{ segment.resolution.levenshtein_distance }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="badge bg-secondary">Initial Stake: {{ segment.initial_stake }} {{ segment.currency }}</span>
                                                    <span class="badge bg-info">{{ segment.stake_count }} bets placed</span>
                                                    {% if segment.submission_count > 0 %}
                                                        <span class="badge bg-warning">{{ segment.submission_count }} submissions</span>
                                                    {% endif %}
                                                    {% if segment.status == 'active' %}
                                                        {% if segment.oracle_allowed %}
                                                            <span class="badge bg-success">
                                                                <i class="fas fa-check-circle"></i> Oracle submission allowed
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-danger">
                                                                <i class="fas fa-clock"></i> Oracle in {{ (segment.time_until_oracle / 3600)|round(1) }}h
                                                            </span>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                                <a href="/clockchain/market/{{ segment.id }}" class="btn btn-sm btn-outline-primary">
                                                    View Details <i class="fas fa-arrow-right"></i>
                                                </a>
                                            </div>
                                            
                                            {% if segment.competing_bets %}
                                            <div class="competing-submissions mt-3">
                                                <small class="text-muted">Competing Submissions:</small>
                                                <div class="list-group list-group-flush mt-1">
                                                    {% for comp in segment.competing_bets %}
                                                    <div class="list-group-item p-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <small>{{ comp.creator }} - "{{ comp.predicted_text }}"</small>
                                                            </div>
                                                            <small class="text-muted">{{ comp.volume }} {{ segment.currency }}</small>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                    {% if segment.submission_count > 3 %}
                                                    <div class="list-group-item p-2 text-center">
                                                        <small class="text-muted">+{{ segment.submission_count - 3 }} more submissions</small>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if not now_marker_shown %}
                            <!-- Current Time Marker at end if all events are in the past -->
                            <div class="w-100 my-4">
                                <div class="d-flex align-items-center">
                                    <div class="bg-danger" style="height: 2px; flex: 1;"></div>
                                    <span class="badge bg-danger mx-2">NOW</span>
                                    <div class="bg-danger" style="height: 2px; flex: 1;"></div>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if not timeline_segments %}
                        <div class="text-center py-5">
                            <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No submissions in selected time range</h5>
                            <p class="text-muted">Try adjusting the time range to see more predictions</p>
                        </div>
                        {% endif %}
                        
                        {% if has_more_pages %}
                        <div class="text-center py-3">
                            <button id="loadMoreBtn" class="btn btn-primary btn-lg" onclick="loadMore()">
                                <i class="fas fa-plus-circle"></i> Load More
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline-container {
    position: relative;
}

.timeline-container::before {
    content: '';
    position: absolute;
    left: calc(16.666% + 8px);
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: var(--bs-gray-400);
    z-index: 0;
}

.timeline-segment {
    position: relative;
    transition: all 0.3s ease;
}

.timeline-segment:hover {
    transform: translateX(5px);
}

.timeline-segment .card {
    position: relative;
    z-index: 1;
}

.timeline-segment .card:hover {
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.timeline-line {
    position: relative;
    height: auto !important;
    min-height: 100px;
}

.timeline-marker {
    z-index: 2;
}

.prediction-text {
    font-size: 0.95rem;
}

.competing-submissions {
    border-top: 1px solid var(--bs-gray-300);
}
</style>

<script>
// Auto-refresh current time
function updateCurrentTime() {
    fetch('/api/time-status')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                document.getElementById('currentTime').textContent = data.current_time || 'N/A';
                document.getElementById('currentMs').textContent = new Date().getTime();
            }
        })
        .catch(error => {
            console.error('Error updating time:', error);
        });
}

// Refresh timeline
function refreshTimeline() {
    location.reload();
}

// Current page for pagination
let currentPage = {{ current_page or 1 }};
const viewType = '{{ view_type }}';

// Load more submissions
function loadMore() {
    currentPage++;
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    loadMoreBtn.disabled = true;
    loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    
    let url = '';
    if (viewType === 'all') {
        url = `/api/clockchain/markets?page=${currentPage}`;
    } else if (viewType === 'active') {
        url = `/api/clockchain/active?page=${currentPage}`;
    } else if (viewType === 'resolved') {
        url = `/api/clockchain/resolved?page=${currentPage}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.segments && data.segments.length > 0) {
                // Add new segments to the timeline
                const timelineContainer = document.querySelector('.timeline-container');
                const existingLoadMore = document.getElementById('loadMoreBtn').parentElement.parentElement;
                
                data.segments.forEach(segment => {
                    const segmentHtml = createSegmentHtml(segment);
                    const div = document.createElement('div');
                    div.innerHTML = segmentHtml;
                    timelineContainer.insertBefore(div.firstChild, existingLoadMore);
                });
                
                if (data.has_more) {
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Load More';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            } else {
                loadMoreBtn.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading more:', error);
            loadMoreBtn.disabled = false;
            loadMoreBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Load More';
        });
}

// Format large hour counts
function formatHours(hours) {
    if (hours >= 8760) {
        const years = Math.floor(hours / 8760);
        const remainingHours = hours % 8760;
        if (remainingHours > 0) {
            const days = Math.floor(remainingHours / 24);
            return `${years} year${years > 1 ? 's' : ''}, ${days} day${days > 1 ? 's' : ''}`;
        }
        return `${years} year${years > 1 ? 's' : ''}`;
    } else if (hours >= 168) {
        const weeks = Math.floor(hours / 168);
        const days = Math.floor((hours % 168) / 24);
        if (days > 0) {
            return `${weeks} week${weeks > 1 ? 's' : ''}, ${days} day${days > 1 ? 's' : ''}`;
        }
        return `${weeks} week${weeks > 1 ? 's' : ''}`;
    } else if (hours >= 24) {
        const days = Math.floor(hours / 24);
        const remainingHours = hours % 24;
        if (remainingHours > 0) {
            return `${days} day${days > 1 ? 's' : ''}, ${remainingHours} hour${remainingHours > 1 ? 's' : ''}`;
        }
        return `${days} day${days > 1 ? 's' : ''}`;
    }
    return `${hours} hour${hours > 1 ? 's' : ''}`;
}

// Create HTML for a segment
function createSegmentHtml(segment) {
    const statusBadgeClass = segment.status === 'active' ? 'bg-primary' : 
                            segment.status === 'resolved' ? 'bg-success' : 'bg-secondary';
    
    let resolutionHtml = '';
    if (segment.status === 'resolved' && segment.resolution) {
        resolutionHtml = `
            <div class="mt-3 p-3 bg-light rounded">
                <small class="text-muted d-block">RESOLVED: ${segment.resolution.actual_text}</small>
                ${segment.resolution.levenshtein_distance !== null ? 
                    `<span class="badge bg-info mt-1">Levenshtein Distance: ${segment.resolution.levenshtein_distance}</span>` : ''}
            </div>
        `;
    }
    
    let oracleHtml = '';
    if (segment.status === 'active') {
        if (segment.oracle_allowed) {
            oracleHtml = '<span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Oracle Submission Open</span>';
        } else if (segment.time_until_oracle) {
            const hours = Math.floor(segment.time_until_oracle / 3600);
            const minutes = Math.floor((segment.time_until_oracle % 3600) / 60);
            oracleHtml = `<span class="badge bg-info"><i class="fas fa-hourglass-half"></i> Oracle opens in ${hours}h ${minutes}m</span>`;
        }
    }
    
    return `
        <div class="row timeline-segment mb-4">
            <div class="col-md-2 text-center">
                <div class="timeline-line d-flex flex-column align-items-center">
                    <div class="timeline-marker bg-primary rounded-circle" style="width: 20px; height: 20px; margin: 40px 0;"></div>
                </div>
            </div>
            <div class="col-md-10">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="card-title mb-1">
                                    <i class="fas fa-user"></i> ${segment.actor.name}
                                    <span class="badge ${statusBadgeClass} ms-2">${segment.status.toUpperCase()}</span>
                                </h5>
                                <small class="text-muted">
                                    ${new Date(segment.start_time).toLocaleString()} - ${new Date(segment.end_time).toLocaleString()}
                                </small>
                            </div>
                            <div class="text-end">
                                <h6 class="mb-0">${segment.total_volume} ${segment.currency}</h6>
                                <small class="text-muted">${segment.submission_count} submissions</small>
                            </div>
                        </div>
                        
                        <div class="prediction-text mb-3">
                            <em>"${segment.predicted_text}"</em>
                        </div>
                        
                        ${resolutionHtml}
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>${oracleHtml}</div>
                            <a href="/clockchain/market/${segment.id}" class="btn btn-sm btn-outline-primary">
                                View Details <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Update time every second
    setInterval(updateCurrentTime, 1000);
    document.querySelector('.card-title').parentElement.appendChild(rangeInfo);
});

// Auto-refresh every 60 seconds
setInterval(refreshTimeline, 60000);
</script>
{% endblock %}